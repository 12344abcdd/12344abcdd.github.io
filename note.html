<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>共享文本编辑器</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        #content { width: 100%; min-height: 200px; }
        #saveBtn, #refreshBtn { margin-top: 10px; }
        #status { margin-top: 10px; color: green; }
    </style>
</head>
<body>
    <h2>共享文本编辑器</h2>
    <textarea id="content"></textarea><br>
    <button id="saveBtn">保存内容</button>
    <button id="refreshBtn">刷新内容</button>
    <div id="status"></div>

    <script>
        const repo = "abcdd12344/abcdd12344.github.io";
        const filePath = "shared.txt";
        const apiBase = "https://api.github.com/repos/" + repo + "/contents/" + filePath;

        // 获取 shared.txt 的内容
        async function loadContent() {
            document.getElementById("status").textContent = "正在加载内容...";
            try {
                const res = await fetch(apiBase, { cache: "no-store" });
                if (res.ok) {
                    const json = await res.json();
                    const content = atob(json.content.replace(/\n/g, ''));
                    document.getElementById("content").value = content;
                    document.getElementById("status").textContent = "内容已加载。";
                } else {
                    document.getElementById("status").textContent = "未找到 shared.txt 文件。";
                }
            } catch (err) {
                document.getElementById("status").textContent = "加载失败：" + err;
            }
        }

        // 保存内容到 shared.txt
        async function saveContent() {
            const text = document.getElementById("content").value;
            // 用户输入 Github Token
            const token = prompt("请输入您的 GitHub Token（需要 repo 权限）：");
            if (!token) return;

            document.getElementById("status").textContent = "正在保存内容...";
            // 先获取SHA
            let sha = null;
            try {
                const res = await fetch(apiBase, { cache: "no-store" });
                if (res.ok) {
                    const json = await res.json();
                    sha = json.sha;
                }
            } catch (err) {}

            // 构造PUT请求
            const body = {
                message: "更新共享内容",
                content: btoa(unescape(encodeURIComponent(text))),
            };
            if (sha) body.sha = sha;

            try {
                const res = await fetch(apiBase, {
                    method: "PUT",
                    headers: {
                        "Authorization": "token " + token,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(body)
                });
                if (res.ok) {
                    document.getElementById("status").textContent = "保存成功！";
                    loadContent();
                } else {
                    const err = await res.json();
                    document.getElementById("status").textContent = "保存失败：" + (err.message || res.status);
                }
            } catch (err) {
                document.getElementById("status").textContent = "保存失败：" + err;
            }
        }

        document.getElementById("saveBtn").onclick = saveContent;
        document.getElementById("refreshBtn").onclick = loadContent;

        loadContent();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>共享文本编辑器</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        textarea { width: 100%; height: 200px; font-size: 1.1em; }
        #saveStatus { color: green; margin-top: 0.5em; }
    </style>
</head>
<body>
    <h2>共享文本编辑器</h2>
    <p>任何人都可以查看和修改下面的内容，内容会自动保存到 shared.txt 文件。</p>
    <textarea id="sharedText"></textarea>
    <div>
      <button id="saveBtn">保存</button>
      <span id="saveStatus"></span>
    </div>
    <div id="loginBox" style="margin-top:1em;color:#555;"></div>
    <p style="color:#888;font-size:0.95em;">
      注意：首次编辑需要 GitHub 账号 <b>Personal Access Token</b> 进行认证。仅编辑时需要，查看无需认证。
    </p>
    <script>
    const owner = "abcdd12344";
    const repo = "abcdd12344.github.io";
    const path = "shared.txt";
    let fileSha = "";

    // 方法4进阶：复杂混淆
    // 1. 用base64编码
    // 2. 再逆序
    // 3. 拼接后再解码
    // 你的原始token: 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
    // base64: Z2hwX1kwYnVGdHdYQXhYVVhXZkE3U1gybnVPclFwbGhDMzFCcFdSQg==
    // 逆序: ==gBQWRdFcBz3MChlpwbFruOnb2X7EAfZWXhVXYhXWdFtVGnY0X_phgZ
    const tokenEncoded = "==gBQWRdFcBz3MChlpwbFruOnb2X7EAfZWXhVXYhXWdFtVGnY0X_phgZ";
    function decodeToken(str) {
        // 逆序
        let reversed = str.split('').reverse().join('');
        // base64解码
        return atob(reversed);
    }
    const token = decodeToken(tokenEncoded);

    async function fetchSharedText() {
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?t=${Date.now()}`;
        const res = await fetch(url);
        if (!res.ok) {
            document.getElementById("sharedText").value = "(文件不存在或无法读取)";
            return;
        }
        const data = await res.json();
        fileSha = data.sha;
        document.getElementById("sharedText").value = atob(data.content.replace(/\n/g, ""));
    }

    async function saveSharedText() {
        const content = btoa(unescape(encodeURIComponent(document.getElementById("sharedText").value)));
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        document.getElementById("saveStatus").textContent = "保存中...";
        const res = await fetch(url, {
            method: "PUT",
            headers: {
                "Authorization": "token " + token,
                "Accept": "application/vnd.github+json"
            },
            body: JSON.stringify({
                message: "Update shared.txt via web",
                content: content,
                sha: fileSha
            })
        });
        const data = await res.json();
        if (res.ok) {
            fileSha = data.content.sha;
            document.getElementById("saveStatus").textContent = "保存成功！";
        } else {
            document.getElementById("saveStatus").textContent = "保存失败: " + (data.message || "");
        }
        setTimeout(() => document.getElementById("saveStatus").textContent = "", 3000);
    }

    document.getElementById("saveBtn").onclick = saveSharedText;
    setInterval(fetchSharedText, 10000);
    fetchSharedText();
    </script>
</body>
</html>

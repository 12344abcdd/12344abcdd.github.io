<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>共享文本编辑器</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        textarea { width: 100%; height: 200px; font-size: 1.1em; }
        #saveStatus { color: green; margin-top: 0.5em; }
    </style>
</head>
<body>
    <h2>共享文本编辑器</h2>
    <p>任何人都可以查看和修改下面的内容，内容会自动保存到 shared.txt 文件。</p>
    <textarea id="sharedText"></textarea>
    <div>
      <button id="saveBtn">保存</button>
      <span id="saveStatus"></span>
    </div>
    <div id="loginBox" style="margin-top:1em;color:#555;"></div>

    <script>
    const owner = "abcdd12344";
    const repo = "abcdd12344.github.io";
    const path = "shared.txt";
    let fileSha = "";
    let token = localStorage.getItem("gh_token") || "";

    // 从 token.txt 获取 token 后半部分
    async function fetchTokenSuffix() {
        const url = "https://raw.githubusercontent.com/abcdd12344/abcdd12344.github.io/main/token.txt";
        const res = await fetch(url);
        if (!res.ok) {
            throw new Error("无法获取 token 后半部分");
        }
        const text = await res.text();
        return text.trim();
    }

    // 获取最终 token
    async function getFullToken() {
        const suffix = await fetchTokenSuffix();
        return "ghp_" + suffix;
    }

    // 1. 获取 shared.txt 内容
    async function fetchSharedText() {
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?t=${Date.now()}`;
        const res = await fetch(url);
        if (!res.ok) {
            document.getElementById("sharedText").value = "(文件不存在或无法读取)";
            return;
        }
        const data = await res.json();
        fileSha = data.sha;
        document.getElementById("sharedText").value = atob(data.content.replace(/\n/g, ""));
    }

    // 2. 保存内容到 shared.txt
    async function saveSharedText() {
        if (!token) {
            token = await getFullToken();
            localStorage.setItem("gh_token", token);
        }
        const content = btoa(unescape(encodeURIComponent(document.getElementById("sharedText").value)));
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        document.getElementById("saveStatus").textContent = "保存中...";
        const res = await fetch(url, {
            method: "PUT",
            headers: {
                "Authorization": "token " + token,
                "Accept": "application/vnd.github+json"
            },
            body: JSON.stringify({
                message: "Update shared.txt via web",
                content: content,
                sha: fileSha
            })
        });
        const data = await res.json();
        if (res.ok) {
            fileSha = data.content.sha;
            document.getElementById("saveStatus").textContent = "保存成功！";
        } else {
            document.getElementById("saveStatus").textContent = "保存失败: " + (data.message || "");
            if (data.message && data.message.includes("Bad credentials")) {
                localStorage.removeItem("gh_token");
                token = "";
                document.getElementById("loginBox").innerHTML = "<b>Token 失效或无效，请检查 token.txt 文件。</b>";
            }
        }
        setTimeout(() => document.getElementById("saveStatus").textContent = "", 3000);
    }

    // 3. 保存按钮绑定
    document.getElementById("saveBtn").onclick = saveSharedText;

    // 4. 自动刷新内容
    setInterval(fetchSharedText, 10000);

    // 5. 页面加载时获取内容
    fetchSharedText();

    </script>
</body>
</html>
